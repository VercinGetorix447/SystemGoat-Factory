import initSqlJs from 'sql.js';
import { readFileSync, writeFileSync } from 'fs';

const dbPath = '/mnt/c/Users/password/Documents/ClaudeCodeProjects/data/workspace.db';

const SQL = await initSqlJs();

// Create new database
const db = new SQL.Database();

// Create schema for conversation memory
db.run(`
  CREATE TABLE IF NOT EXISTS conversations (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    session_id TEXT NOT NULL,
    started_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    ended_at DATETIME,
    summary TEXT,
    topics TEXT,
    key_decisions TEXT,
    working_directory TEXT
  );
`);

db.run(`
  CREATE TABLE IF NOT EXISTS entities (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    name TEXT NOT NULL UNIQUE,
    type TEXT NOT NULL,
    description TEXT,
    first_seen DATETIME DEFAULT CURRENT_TIMESTAMP,
    last_seen DATETIME DEFAULT CURRENT_TIMESTAMP,
    metadata TEXT
  );
`);

db.run(`
  CREATE TABLE IF NOT EXISTS insights (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    conversation_id INTEGER,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    category TEXT,
    content TEXT NOT NULL,
    importance INTEGER DEFAULT 5,
    FOREIGN KEY (conversation_id) REFERENCES conversations(id)
  );
`);

db.run(`
  CREATE TABLE IF NOT EXISTS user_preferences (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    key TEXT NOT NULL UNIQUE,
    value TEXT NOT NULL,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP
  );
`);

db.run(`
  CREATE INDEX IF NOT EXISTS idx_conversations_session ON conversations(session_id);
  CREATE INDEX IF NOT EXISTS idx_entities_name ON entities(name);
  CREATE INDEX IF NOT EXISTS idx_insights_category ON insights(category);
`);

// Save to file
const data = db.export();
const buffer = Buffer.from(data);
writeFileSync(dbPath, buffer);

console.log('Database initialized with schema:');
console.log('- conversations: session summaries and metadata');
console.log('- entities: people, projects, concepts I should remember');
console.log('- insights: key learnings and decisions');
console.log('- user_preferences: your preferences and settings');

db.close();
