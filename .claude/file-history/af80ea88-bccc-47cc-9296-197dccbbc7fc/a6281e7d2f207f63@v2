#!/bin/bash
# Unsplash Image Library v1
# Usage: unsplash.sh search <query> [count]
#        unsplash.sh random [query]
#        unsplash.sh download <url> <filename>

# API Key - Get free at https://unsplash.com/developers
UNSPLASH_KEY="${UNSPLASH_ACCESS_KEY:-}"
API_BASE="https://api.unsplash.com"

# Check for API key
if [ -z "$UNSPLASH_KEY" ]; then
    if [ -f ~/.claude/.env ]; then
        source ~/.claude/.env
        UNSPLASH_KEY="${UNSPLASH_ACCESS_KEY:-}"
    fi
fi

if [ -z "$UNSPLASH_KEY" ]; then
    echo "Error: UNSPLASH_ACCESS_KEY not set"
    echo "Get free key at: https://unsplash.com/developers"
    echo "Add to ~/.claude/.env: UNSPLASH_ACCESS_KEY=your_key"
    exit 1
fi

search_images() {
    local query="$1"
    local count="${2:-5}"

    echo "Searching: $query (limit: $count)"
    echo ""

    curl -s "$API_BASE/search/photos?query=$query&per_page=$count" \
        -H "Authorization: Client-ID $UNSPLASH_KEY" | \
    jq -r '.results[] | "[\(.id)] \(.alt_description // "No description")\n    URL: \(.urls.regular)\n    By: \(.user.name)\n"'
}

random_image() {
    local query="${1:-}"
    local url="$API_BASE/photos/random"
    [ -n "$query" ] && url="$url?query=$query"

    echo "Random image${query:+ ($query)}:"
    echo ""

    curl -s "$url" -H "Authorization: Client-ID $UNSPLASH_KEY" | \
    jq -r '"ID: \(.id)\nDescription: \(.alt_description // "None")\nURL: \(.urls.regular)\nDownload: \(.links.download)\nBy: \(.user.name)"'
}

download_image() {
    local url="$1"
    local filename="$2"

    if [ -z "$url" ] || [ -z "$filename" ]; then
        echo "Usage: unsplash.sh download <url> <filename>"
        exit 1
    fi

    echo "Downloading to: $filename"
    curl -sL "$url" -o "$filename"

    if [ -f "$filename" ]; then
        echo "✓ Downloaded: $(ls -lh "$filename" | awk '{print $5}')"
    else
        echo "✗ Download failed"
    fi
}

case "${1:-help}" in
    search)
        search_images "$2" "$3"
        ;;
    random)
        random_image "$2"
        ;;
    download)
        download_image "$2" "$3"
        ;;
    *)
        echo "Unsplash Image Library"
        echo ""
        echo "Usage:"
        echo "  unsplash.sh search <query> [count]  - Search images"
        echo "  unsplash.sh random [query]          - Get random image"
        echo "  unsplash.sh download <url> <file>   - Download image"
        echo ""
        echo "Setup:"
        echo "  1. Get free API key: https://unsplash.com/developers"
        echo "  2. Add to ~/.claude/.env: UNSPLASH_ACCESS_KEY=your_key"
        ;;
esac
