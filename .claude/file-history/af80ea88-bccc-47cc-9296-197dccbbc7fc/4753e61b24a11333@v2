#!/bin/bash
# Tiered Backup System v5
# Usage: backup.sh [daily|weekly|now|recover|status]

CLAUDE_DIR="/mnt/c/Users/password/Documents/.claude"
REPORTS_DIR="$CLAUDE_DIR/reports"
CHECKPOINT_DB="$CLAUDE_DIR/checkpoint.db"
EVENTS_FILE="$REPORTS_DIR/events.yaml"
NTFY_URL="http://localhost:8095/backup-alerts"

DATE=$(date +%Y-%m-%d)
TS=$(date +%s)

# Colors
GREEN='\033[0;32m'
RED='\033[0;31m'
NC='\033[0m'

log_event() {
    local type=$1
    local delta=$2
    local hash=$(echo "$delta" | md5sum | cut -c1-6)
    echo "- ts: $TS" >> "$EVENTS_FILE"
    echo "  t: $type" >> "$EVENTS_FILE"
    echo "  h: $hash" >> "$EVENTS_FILE"
    echo "  d: \"$delta\"" >> "$EVENTS_FILE"
    echo ""  >> "$EVENTS_FILE"
}

alert_failure() {
    curl -s -d "Backup failed: $1" "$NTFY_URL" 2>/dev/null || true
}

case "${1:-status}" in
    daily)
        echo -e "${GREEN}Running daily backup...${NC}"

        # Get current state from SQLite
        VERSION=$(sqlite3 "$CHECKPOINT_DB" "SELECT COALESCE(MAX(version),0)+1 FROM checkpoints WHERE date='$DATE'")
        DONE=$(sqlite3 "$CHECKPOINT_DB" "SELECT tasks_done FROM checkpoints ORDER BY id DESC LIMIT 1")
        PENDING=$(sqlite3 "$CHECKPOINT_DB" "SELECT tasks_pending FROM checkpoints ORDER BY id DESC LIMIT 1")
        ERRORS=$(sqlite3 "$CHECKPOINT_DB" "SELECT errors FROM checkpoints ORDER BY id DESC LIMIT 1")

        # Generate .md file
        cat > "$REPORTS_DIR/$DATE.md" << EOF
# $DATE
v$VERSION: Daily checkpoint
Done: $DONE
Pending: $PENDING
Errors: $ERRORS
Next: Check DocuSeal, test integrations, deploy workflows
EOF

        # Update SQLite
        sqlite3 "$CHECKPOINT_DB" "INSERT INTO checkpoints (ts, date, version, tasks_done, tasks_pending, errors) VALUES ($TS, '$DATE', $VERSION, $DONE, $PENDING, '$ERRORS')"

        log_event "backup" "daily v$VERSION"
        echo -e "${GREEN}✓ Daily backup complete: $REPORTS_DIR/$DATE.md${NC}"
        ;;

    weekly)
        echo -e "${GREEN}Running weekly backup...${NC}"

        # GitHub push
        cd "$CLAUDE_DIR" && git add -A && git commit -m "Weekly backup: $DATE" && git push 2>/dev/null
        if [ $? -eq 0 ]; then
            echo -e "${GREEN}✓ GitHub push complete${NC}"
        else
            echo -e "${RED}✗ GitHub push failed${NC}"
            alert_failure "GitHub push failed"
        fi

        # Archive old .md files
        mkdir -p "$REPORTS_DIR/archive"
        find "$REPORTS_DIR" -maxdepth 1 -name "*.md" -mtime +7 -exec mv {} "$REPORTS_DIR/archive/" \;

        log_event "backup" "weekly sync"
        echo -e "${GREEN}✓ Weekly backup complete${NC}"
        ;;

    now)
        echo -e "${GREEN}Running emergency backup...${NC}"

        # All destinations
        $0 daily
        $0 weekly

        log_event "backup" "emergency all"
        echo -e "${GREEN}✓ Emergency backup complete${NC}"
        ;;

    recover)
        echo -e "${GREEN}Recovering from checkpoint...${NC}"

        # Read latest checkpoint
        sqlite3 -header -column "$CHECKPOINT_DB" "SELECT date, version, summary, tasks_done, tasks_pending, errors FROM checkpoints ORDER BY id DESC LIMIT 1"

        # Read recent events
        echo ""
        echo "Recent events:"
        tail -20 "$EVENTS_FILE" 2>/dev/null || echo "No events found"
        ;;

    status|*)
        echo "=== Backup System v5 Status ==="
        echo ""
        echo "Checkpoint DB: $(ls -lh "$CHECKPOINT_DB" 2>/dev/null | awk '{print $5}' || echo 'missing')"
        echo "Events file: $(wc -l < "$EVENTS_FILE" 2>/dev/null || echo 0) lines"
        echo "Today's .md: $(ls "$REPORTS_DIR/$DATE.md" 2>/dev/null && echo 'exists' || echo 'missing')"
        echo ""
        echo "Last checkpoint:"
        sqlite3 "$CHECKPOINT_DB" "SELECT date || ' v' || version || ': ' || COALESCE(summary,'no summary') FROM checkpoints ORDER BY id DESC LIMIT 1" 2>/dev/null
        echo ""
        echo "Schedule:"
        echo "  Daily:  6PM  → .md + SQLite"
        echo "  Weekly: Sun 8PM → GitHub + archive"
        ;;
esac
