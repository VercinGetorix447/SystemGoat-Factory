#!/bin/bash
# Claude Memory Backup Script
# Converts memory.jsonl to daily markdown backup, updates every 5 minutes

MEMORY_FILE="/mnt/c/Users/password/Documents/.claude/databases/memory.jsonl"
BACKUP_DIR="/mnt/c/Users/password/Documents/.claude/Backups"
DATE=$(date +%Y-%m-%d)
BACKUP_FILE="${BACKUP_DIR}/memory-backup-${DATE}.md"

# Create backup directory if it doesn't exist
mkdir -p "$BACKUP_DIR"

# Generate markdown header
cat > "$BACKUP_FILE" << 'HEADER'
# Claude Memory Backup

> Last updated: TIMESTAMP

---

HEADER

# Replace timestamp
sed -i "s/TIMESTAMP/$(date '+%Y-%m-%d %H:%M:%S')/" "$BACKUP_FILE"

# Parse JSONL and convert to markdown
if [ -f "$MEMORY_FILE" ]; then
    while IFS= read -r line; do
        type=$(echo "$line" | grep -o '"type":"[^"]*"' | cut -d'"' -f4)

        if [ "$type" = "entity" ]; then
            name=$(echo "$line" | grep -o '"name":"[^"]*"' | cut -d'"' -f4)
            entityType=$(echo "$line" | grep -o '"entityType":"[^"]*"' | cut -d'"' -f4)

            echo "## $name" >> "$BACKUP_FILE"
            echo "**Type:** $entityType" >> "$BACKUP_FILE"
            echo "" >> "$BACKUP_FILE"

            # Extract observations
            observations=$(echo "$line" | grep -o '"observations":\[[^]]*\]' | sed 's/"observations":\[//;s/\]$//')
            echo "**Observations:**" >> "$BACKUP_FILE"
            echo "$observations" | tr ',' '\n' | sed 's/^"//;s/"$//;s/^/- /' >> "$BACKUP_FILE"
            echo "" >> "$BACKUP_FILE"
            echo "---" >> "$BACKUP_FILE"
            echo "" >> "$BACKUP_FILE"

        elif [ "$type" = "relation" ]; then
            from=$(echo "$line" | grep -o '"from":"[^"]*"' | cut -d'"' -f4)
            to=$(echo "$line" | grep -o '"to":"[^"]*"' | cut -d'"' -f4)
            relationType=$(echo "$line" | grep -o '"relationType":"[^"]*"' | cut -d'"' -f4)

            echo "**Relation:** $from → $relationType → $to" >> "$BACKUP_FILE"
            echo "" >> "$BACKUP_FILE"
        fi
    done < "$MEMORY_FILE"
fi

echo "Backup completed: $BACKUP_FILE"
